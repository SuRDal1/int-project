<html layout:decorate="~{layout}" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<div class="container my-5" layout:fragment="content">
    <!-- ì£¼ë¬¸ ì˜ì—­ ì‹œì‘ -->
    <div class="row align-items-stretch gy-4" style="min-height: 500px;">
        <!-- ì™¼ìª½: ì œí’ˆ ì£¼ë¬¸ í¼ -->
        <div class="col-md-6 d-flex">
            <div class="card p-4 w-100 h-100 d-flex flex-column justify-content-between">
                <h3 class="fw-bold mb-5 text-center">ì œí’ˆ ì£¼ë¬¸</h3>
                <!-- thymeleaf í¼ ì‹œì‘ -->
                <form th:action="@{/order}" th:object="${orderForm}" method="post" class="flex-grow-1 d-flex flex-column justify-content-between">
                    <!-- ì œí’ˆëª… -->
                    <div class="mb-3 px-4">
                        <label class="fw-bold d-block mb-3 text-start" style="margin-left: 0.25rem;">ì œí’ˆëª…</label>
                        <div class="d-flex flex-wrap" style="gap: 8px;">
                            <div th:each="type : ${productName}" style="flex: 1 0 calc(50% - 8px); max-width: 48%;">
                                <input type="radio"
                                       th:field="*{productName}"
                                       th:value="${type}"
                                       class="btn-check product-radio"
                                       th:id="${type}"
                                       th:data-img="${type.imageUrl}"
                                       autocomplete="off">
                                <label class="btn btn-outline-dark w-100 py-1 px-2 text-center"
                                       th:for="${type}" th:text="${type.getLabel()}"
                                       style="font-size: 0.85rem;">
                                </label>
                            </div>
                        </div>
                    </div>
                    <!-- ìˆ˜ëŸ‰ ë²„íŠ¼ -->
                    <div class="pt-2 px-4">
                        <label class="fw-bold mb-2 d-block text-start mt-3">ìˆ˜ëŸ‰</label>
                        <div class="d-flex justify-content-center align-items-center border rounded-pill px-2 mb-3"
                             style="width: fit-content; margin: 0 auto;">
                            <button type="button" class="btn btn-outline-secondary btn-sm border-0 px-3" id="decrease-btn">-
                            </button>
                            <input type="text"
                                   id="quantity-input"
                                   name="orderQuantity"
                                   class="form-control text-center border-0 px-2"
                                   th:value="${orderForm.orderQuantity != null ? orderForm.orderQuantity : 0}"
                                   style="width: 60px;">
                            <button type="button" class="btn btn-outline-secondary btn-sm border-0 px-3" id="increase-btn">+
                            </button>
                            <div class="field-error" th:errors="*{orderQuantity}"></div>
                        </div>
                    </div>
                    <!-- ê³µì •ì‹œì‘ì¼ ì…ë ¥ë€ -->
                    <div class="pt-3 px-4">
                        <p class="fw-bold mb-3">ê³µì •ì˜ˆì •ì¼</p>
                        <input class="form-control mb-2" type="date" th:field="*{processDate}" th:attr="min=${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
                    </div>
                    <!-- ì£¼ë¬¸ì²˜ ì„ íƒ ë²„íŠ¼ -->
                    <div class="pt-3 px-4">
                        <p class="text-start fw-bold mb-3">ì£¼ë¬¸ì²˜</p>
                        <div class="d-flex justify-content-center">
                            <div class="d-flex flex-nowrap overflow-auto" style="gap: 12px; padding-bottom: 6px;">
                                <!-- ê°œë³„ ë²„íŠ¼ -->
                                <div th:each="company : ${orderCompany}">
                                    <input type="radio" th:field="*{orderCompany}" th:value="${company}" class="btn-check company-radio" th:id="${company}" autocomplete="off">
                                    <label class="btn btn-outline-dark text-nowrap px-3 py-2"
                                           th:for="${company}"
                                           th:text="${company.getLabel()}"
                                           >
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ë²„íŠ¼ -->
                    <div class="text-end mt-4">
                        <button type="submit" th:formaction="@{/order/cart/add}" formmethod="post"  class="btn btn-outline-main">ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸°</button>
                        <a role="button" class="btn btn-secondary ms-2" th:href="@{/}">ì·¨ì†Œ</a>
                    </div>
                    <!-- ëˆ„ë½ê°’ ì•Œë¦¼ì°½ -->
                    <div class="alert py-3 mt-3" role="alert" th:if="${#fields.hasAnyErrors()}">
                        <div class="field-error fw-bold my-3" th:each="err : ${#fields.allErrors()}" th:text="${err}">ì˜¤ë¥˜ ë©”ì‹œì§€</div>
                        <a class="btn btn-warning rounded-4" th:href="@{/material}">ì¬ë£Œ ì£¼ë¬¸í•˜ê¸°</a>
                    </div>
                </form>
                <!-- thymeleaf í¼ ë -->
            </div>
        </div>
        <!-- ì˜¤ë¥¸ìª½: ì œí’ˆ ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ -->
        <div class="col-md-6 d-flex align-items-center justify-content-center">
            <!-- ë¹„ìœ¨ ê°•ì œí•˜ê³ , ë‚´ë¶€ëŠ” ê½‰ ì°¨ê²Œ (ì˜ë¦¼ ê°ìˆ˜) -->
            <div style="aspect-ratio: 3 / 2;" class="w-100 h-100 d-flex align-items-center justify-content-center border rounded shadow overflow-hidden">
                <img id="product-image"
                     th:src="${selectedProductImageUrl != null ? selectedProductImageUrl : '/image/productHere.png'}"
                     class="img-fluid w-100 h-100"
                     style="object-fit: cover;"
                     alt="ì œí’ˆ ì´ë¯¸ì§€">
            </div>
        </div>
    </div>
    <!-- ì£¼ë¬¸ ì˜ì—­ ë -->
    <!-- ì¥ë°”êµ¬ë‹ˆ ì˜ì—­ ì‹œì‘ -->
    <hr class="my-5">
    <div id="shoppingCart" class="container mt-4 s-target">
        <h4 class="fw-bold mb-4">ğŸ›’ ì¥ë°”êµ¬ë‹ˆ ëª©ë¡</h4>
        <!-- ì¹´ë“œ ëª©ë¡ ì˜ì—­ -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <div class="col" th:each="item, itemStat : ${cart}">
                <div class="card shadow rounded-4 h-100 border-light">
                    <div class="card-body d-flex flex-column justify-content-between p-4">
                        <!-- ì œí’ˆëª… -->
                        <h5 class="card-title fw-bold text-dark mb-3" th:text="${item.productName.label}">ì œí’ˆëª…</h5>
                        <!-- ì •ë³´ ëª©ë¡ -->
                        <ul class="list-unstyled mb-4">
                            <li class="mb-2">
                                <span class="fw-semibold text-secondary">ìˆ˜ëŸ‰:</span>
                                <span class="ms-2 text-dark fw-bold" th:text="${item.orderQuantity}">0</span>
                            </li>
                            <li class="mb-2">
                                <span class="fw-semibold text-secondary">ê³µì •ì˜ˆì •ì¼:</span>
                                <span class="ms-2 text-dark fw-bold" th:text="${item.processDate}">0000-00-00</span>
                            </li>
                            <li>
                                <span class="fw-semibold text-secondary">ì£¼ë¬¸ì²˜:</span>
                                <span class="ms-2 text-dark fw-bold" th:text="${item.orderCompany.getLabel()}">íšŒì‚¬ëª…</span>
                            </li>
                        </ul>
                        <!-- ì‚­ì œ ë²„íŠ¼ -->
                        <form th:action="@{/order/cart/delete}" method="post" class="text-end">
                            <input type="hidden" name="index" th:value="${itemStat.index}" />
                            <button type="submit" class="btn btn-outline-danger btn-sm px-3">
                                ì‚­ì œ
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <!-- ì¥ë°”êµ¬ë‹ˆ ë¹„ì–´ ìˆì„ ê²½ìš° -->
            <div class="col" th:if="${cart.size() == 0}">
                <div class="card text-center text-muted border-0">
                    <div class="card-body py-5">
                        <p class="mb-0">ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸´ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ì¥ë°”êµ¬ë‹ˆ ì˜ì—­ ë -->
    <!-- ì£¼ë¬¸ ë²„íŠ¼ -->
    <form th:action="@{/order/cart/checkout}" method="post" class="text-end mt-4">
        <button type="submit" class="btn btn-main px-4 py-2">ì¥ë°”êµ¬ë‹ˆ ì£¼ë¬¸í•˜ê¸°</button>
    </form>
    <!--Modal-->
    <!-- ì œí’ˆëª… ë¯¸ì„ íƒ ëª¨ë‹¬ -->
    <div class="modal fade" id="productNameAlertModal" tabindex="-1" aria-labelledby="productNameAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger-subtle">
                    <h5 class="modal-title" id="productNameAlertModalLabel">ì•Œë¦¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body text-center">
                    ì œí’ˆëª…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 0ê°œë¥¼ ì…ë ¥í–ˆì„ ë–„ ëœ¨ëŠ” ëª¨ë‹¬ -->
    <div class="modal fade" id="quantityAlertModal" tabindex="-1" aria-labelledby="quantityAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger-subtle">
                    <h5 class="modal-title" id="quantityAlertModalLabel">ì•Œë¦¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body text-center">
                    ìˆ˜ëŸ‰ì€ 1ê°œ ì´ìƒì´ì–´ì•¼ ì¥ë°”êµ¬ë‹ˆì— ë‹´ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ë¶€ì¡±í•œ ì¬ë£Œ ì•ˆë‚´ ëª¨ë‹¬ -->
    <div class="modal fade" id="materialErrorModal" tabindex="-1" aria-labelledby="materialErrorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger-subtle">
                    <h5 class="modal-title" id="materialErrorModalLabel">ì¬ë£Œ ë¶€ì¡±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body text-center text-danger fw-bold">
                    <span th:text="${materialError}">ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤</span>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ê³µì •ì˜ˆì •ì¼ ë¯¸ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal fade" id="processDateAlertModal" tabindex="-1" aria-labelledby="processDateAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger-subtle">
                    <h5 class="modal-title" id="processDateAlertModalLabel">ì•Œë¦¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body text-center">
                    ê³µì • ì˜ˆì •ì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ì£¼ë¬¸ì²˜ ë¯¸ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal fade" id="companyAlertModal" tabindex="-1" aria-labelledby="processDateAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger-subtle">
                    <h5 class="modal-title" id="processDateAlertModalLabel">ì•Œë¦¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body text-center">
                    ì£¼ë¬¸ì²˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
    <!-- ì¥ë°”êµ¬ë‹ˆ ë¹„ì—ˆì„ ë•Œ ì•Œë¦¼ ëª¨ë‹¬ -->
    <div class="modal fade" id="emptyCartModal" tabindex="-1" aria-labelledby="emptyCartModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning-subtle">
                    <h5 class="modal-title" id="emptyCartModalLabel">ì•Œë¦¼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
                </div>
                <div class="modal-body text-center">
                    ì¥ë°”êµ¬ë‹ˆì— ì œí’ˆì„ ë¨¼ì € ë‹´ì•„ì£¼ì„¸ìš”.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ì „ì²´ ë³´ì¡°ìš© ìŠ¤í¬ë¦½íŠ¸ -->
<script layout:fragment="script" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // ìˆ˜ëŸ‰ ì…ë ¥ ë²„íŠ¼ìš© ë³€ìˆ˜ ì„ ì–¸
        const quantityInput = document.getElementById('quantity-input');
        const increaseBtn = document.getElementById('increase-btn');
        const decreaseBtn = document.getElementById('decrease-btn');
        const productRadios = document.querySelectorAll('.product-radio');
        const productImage = document.getElementById('product-image');
        const processDateInput = document.querySelector('input[name="processDate"]');

        // ìˆ˜ëŸ‰ ì¡°ì ˆ ë²„íŠ¼
        decreaseBtn.addEventListener('click', () => {
            let val = parseInt(quantityInput.value);
            if (!isNaN(val) && val > 1) quantityInput.value = val - 1;
        });

        increaseBtn.addEventListener('click', () => {
            let val = parseInt(quantityInput.value);
            if (!isNaN(val)) quantityInput.value = val + 1;
        });

        // ì´ë¯¸ì§€ ë³€ê²½
        productRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                const imgUrl = radio.dataset.img;
                if (imgUrl) {
                    productImage.src = imgUrl;
                }
            });
        });

        // ì¥ë°”êµ¬ë‹ˆ ìœ íš¨ì„± ê²€ì‚¬ (ë‹´ê¸°ìš©)
        const cartBtn = document.querySelector('button[formaction="/order/cart/add"]');
        cartBtn.addEventListener('click', function (event) {
            let quantity = parseInt(quantityInput.value);
            let processDate = processDateInput.value;
            const selectedProduct = document.querySelector('.product-radio:checked');
            const selectedCompany = document.querySelector('.company-radio:checked');


            // ì œí’ˆëª… ì„ íƒ ì•ˆ í–ˆì„ ë•Œ
            if (!selectedProduct) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('productNameAlertModal'));
                modal.show();
                return;
            }

            // ìˆ˜ëŸ‰ 1 ë¯¸ë§Œì¼ ë•Œ
            if (isNaN(quantity) || quantity < 1) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('quantityAlertModal'));
                modal.show();
                return;
            }

            // ê³µì •ì˜ˆì •ì¼ ì…ë ¥ ì•ˆ í–ˆì„ ë•Œ
            if (!processDate) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('processDateAlertModal'));
                modal.show();
            }

            // ì£¼ë¬¸ì²˜ ì…ë ¥ ì•ˆ í–ˆì„ ë•Œ
            if (!selectedCompany) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('companyAlertModal'));
                modal.show();
            }
        });


        // ì¥ë°”êµ¬ë‹ˆ ë¹„ì—ˆëŠ”ì§€ ì²´í¬ (ì£¼ë¬¸í•˜ê¸°ìš©)
        const checkoutBtn = document.querySelector('form[action="/order/cart/checkout"] button[type="submit"]');
        checkoutBtn.addEventListener('click', function (event) {
            const cartItems = document.querySelectorAll('#shoppingCart .card');
            const emptyMessage = document.querySelector('#shoppingCart .text-muted');
            const hasItems = cartItems.length > 0 && !emptyMessage;

            if (!hasItems) {
                event.preventDefault();
                const modal = new bootstrap.Modal(document.getElementById('emptyCartModal'));
                modal.show();
            }
        });


        // ì¬ë£Œ ë¶€ì¡±ìœ¼ë¡œ ì¸í•œ ì£¼ë¬¸ ì‹¤íŒ¨ ì•Œë¦¼ ëª¨ë‹¬
        const materialErrorMessage = /*[[${materialError}]]*/ '';
        if (materialErrorMessage && materialErrorMessage !== '') {
            const modal = new bootstrap.Modal(document.getElementById('materialErrorModal'));
            modal.show();
        }
    });
</script>
</html>
