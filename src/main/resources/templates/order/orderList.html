<html layout:decorate="~{layout.html}" lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<div class="container my-5" layout:fragment="content">
    <h1 class="fw-bold"><i class="fa-solid fa-warehouse me-3" style="color: #a0522d;"></i>ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸</h1>
    <!-- ê³µì • ì˜ˆì •ì¼ + ì£¼ë¬¸ ë²„íŠ¼ ì •ë ¬ -->
    <div class="d-flex flex-wrap justify-content-between align-items-center mx-md-5 my-5">
        <div class="mt-2">
            <label for="processDateInput" class="form-label fw-bold mb-1">ğŸ“… ê³µì • ì˜ˆì •ì¼ë¡œ ë³´ê¸°:</label><br>
            <input type="date" id="processDateInput" class="form-control w-auto d-inline-block"
                   th:value="${#temporals.format(T(java.time.LocalDate).now(),'yyyy-MM-dd')}" />
        </div>
        <div>
            <br>
            <a th:href="@{/}" class="btn btn-point mt-2 me-2">ì˜¤ëŠ˜ì˜ ê³µì • ì‹œì‘</a>
            <a th:href="@{/order}" class="btn btn-point mt-2">ì œí’ˆ ì£¼ë¬¸</a>
        </div>
    </div>
    <!-- íšŒì‚¬ë³„ ê³µì • ì˜ˆì • ë¦¬ìŠ¤íŠ¸ (scriptë¡œ ë‚´ìš© ì¶”ì… êµ¬ì¡°) -->
    <div id="groupedResult" class="mt-4 mx-md-5"></div>
    <!-- ì „ì²´ ê³µì • ë¦¬ìŠ¤íŠ¸ í† ê¸€ -->
    <div class="accordion mx-md-5 mt-5" id="fullOrderAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    ğŸ“‹ ì „ì²´ ê³µì • í™•ì¸
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#fullOrderAccordion">
                <div class="accordion-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover text-nowrap">
                            <thead class="table-dark">
                                <tr>
                                    <th>No.</th>
                                    <th>ì œí’ˆëª…</th>
                                    <th>ìˆ˜ëŸ‰</th>
                                    <th>ì£¼ë¬¸ë‚ ì§œ</th>
                                    <th>ê³µì •ì˜ˆì •ì¼</th>
                                    <th>ë‹´ë‹¹ì</th>
                                    <th>ì£¼ë¬¸ì²˜</th>
                                    <th>ì²˜ë¦¬ìƒíƒœ</th>
                                    <th>ì •ìƒí’ˆëª©</th>
                                    <th>ë¶ˆëŸ‰í’ˆëª©</th>
                                    <th>ì£¼ë¬¸ ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each = "order : ${orderList}" class="align-middle">
                                    <th th:text = "${order.id}"></th>
                                    <th th:text = "${order.productName.getLabel()}"></th>
                                    <td th:text = "${order.orderQuantity}"></td>
                                    <td th:text="${#temporals.format(order.orderDate, 'yyyy-MM-dd HH:mm')}"></td>
                                    <td th:text="${#temporals.format(order.processDate, 'yyyy-MM-dd')}"></td>
                                    <th th:text = "${order.users.name}"></th>
                                    <th th:text = "${order.orderCompany.getLabel()}"></th>
                                    <td th:text = "${order.orderState.getLabel()}"></td>
                                    <td th:text = "${okMap[order.id]}?:0"></td>
                                    <td th:text = "${ngMap[order.id]}?:0"></td>
                                    <!-- ë²„íŠ¼ ë¬¶ìŒ -->
                                    <td class="d-flex justify-content-center">
                                        <a class="btn btn-primary btn-sm"
                                           th:if="${order.productName.name() != 'LAMP_COVER' and (order.orderState.name() == 'IN_PROGRESS' or  order.orderState.name() == 'COMPLETED')}"
                                           th:href="@{/process/a/{id}(id=${order.id})}">
                                            ê³µì •ë³´ê¸°
                                        </a>
                                        <a class="btn btn-primary btn-sm"
                                           th:if="${order.productName.name() == 'LAMP_COVER' and (order.orderState.name() == 'IN_PROGRESS' or order.orderState.name() == 'COMPLETED')}"
                                           th:href="@{/process/b/{id}(id=${order.id})}">
                                            ê³µì •ë³´ê¸°
                                        </a>
                                        <!-- ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ -->
                                        <div th:if="${(order.users.id == session.loginMember.id or session.loginMember.grade.name() == 'MANAGER') and order.orderState.name() == 'PENDING'}" class="d-flex">
                                            <!-- ìˆ˜ì • -->
                                            <a th:href="@{/order/update/{orderId}(orderId=${order.id})}"
                                               class="btn btn-point btn-sm me-2">
                                                ìˆ˜ì •
                                            </a>
                                            <!-- ì·¨ì†Œ(ì‚­ì œ) -->
                                            <button type="button" class="btn btn-danger btn-sm me-2"
                                                    data-bs-toggle="modal"
                                                    th:attr="data-bs-target='#cancelModal-' + ${order.id}">
                                                ì‚­ì œ
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- ì£¼ë¬¸ ì·¨ì†Œ ëª¨ë‹¬ ì‹œì‘ -->
                        <div th:each="order : ${orderList}">
                            <div class="modal fade" th:id="'cancelModal-' + ${order.id}" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <form th:action="@{/order/cancel}" method="post">
                                            <div class="modal-header">
                                                <h5 class="modal-title">ì£¼ë¬¸ ì·¨ì†Œ í™•ì¸</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body text-start">
                                                <input type="hidden" name="orderId" th:value="${order.id}">
                                                <label class="mb-1">ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:</label>
                                                <textarea name="cancelText" class="form-control" rows="3" required></textarea>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                                                <button type="submit" class="btn btn-danger">í™•ì¸</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ì£¼ë¬¸ ì·¨ì†Œ ëª¨ë‹¬ ë -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ì œí’ˆë³„ ëª©í‘œ ìˆ˜ëŸ‰ -->
    <div class="d-flex align-items-center justify-content-center p-4 rounded mt-5">
        <i class="bi bi-bullseye display-4 text-primary me-3"></i>
        <div>
            <p class="mb-0 fs-5 fw-bold">ì œí’ˆë³„ ëª©í‘œ ìˆ˜ëŸ‰</p>
            <h2 class="text-danger fw-bold text-center">500ê°œ</h2>
        </div>
    </div>
    <!-- ì œí’ˆë³„ ì´ìˆ˜ëŸ‰ ê²Œì´ì§€ -->
    <div class="container text-center row row-cols-1 row-cols-md-3 g-4 mx-3 mt-5">
        <div class="col" th:each="entry : ${productNameLongMap.entrySet()}">
            <div class="card shadow h-100 border-0" style="border-radius: 20px;">
                <div class="card-body">
                    <h5 class="card-title fw-bold" th:text="${entry.key.getLabel()}">ì œí’ˆëª…</h5>
                    <p class="card-text">
                        <strong>ì´ ìˆ˜ëŸ‰</strong>: <span class="fw-bold" th:text="${entry.value}">0</span><strong>ê°œ</strong>
                    </p>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar"
                             role="progressbar"
                             th:style="'width:' + (${entry.value/5 ?: 0}) + '%; background-color: #ff8a44;'">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- ì¶”ê°€ script ì‹œì‘ -->
<script th:inline="javascript" layout:fragment="script">
    // ê³µì •ì˜ˆì •ì¼ + ì£¼ë¬¸ì²˜ë³„ ì£¼ë¬¸ - ê³µì • í‘œì‹œ script (Controllerì˜ "/order/groupedByCompany?date=${dateStr}"ì™€ ì—°ê³„)
    function loadGroupedOrders(dateStr) {
        // fetch(`/order/groupedByCompany?date=${dateStr}`)ë¥¼ í†µí•´ í•´ë‹¹í•˜ëŠ” íŒŒë¼ë¯¸í„°ë¥¼ ë°›ì€ ì£¼ì†Œê°’ì˜ ì»¨íŠ¸ë¡¤ëŸ¬ ì‹¤í–‰
        fetch(`/order/groupedByCompany?date=${dateStr}`)
            // fetchì˜ returnê°’ì¸ responseë¥¼ jsonì²˜ë¦¬ ì´í›„ ì´ë¥¼ dataë¡œ ë‘ê³  ë§ˆì € ì²˜ë¦¬ì§„í–‰
            .then(response => response.json())
            .then(data => {
                let html = '';
                // í‘œì‹œê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•  companiesë¥¼ .sort()ë¡œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬(A->Z)
                const companies = Object.keys(data).sort();

                // ê¸¸ì´ê°€ 0 -> í•´ë‹¹ì¼ ê³µì • X, ì•„ë‹ ê²½ìš° ê°œë³„ íšŒì‚¬ë³„ í…Œì´ë¸” ì¶”ê°€
                if (companies.length === 0) {
                    html = '<h5 class="text-danger py-3">ğŸ“­ ì˜ˆì •ëœ ê³µì •ì´ ì—†ìŠµë‹ˆë‹¤.</h5>';
                } else {
                    // í•´ë‹¹ì¼ìì— ì¡´ì¬í•˜ëŠ” ì£¼ë¬¸ì²˜ë§Œí¼ ë°˜ë³µ
                    for (const company of companies) {
                        // ì œëª©(ì£¼ë¬¸ì²˜ëª…) íƒœê·¸
                        html += `<h4 class="mb-4 fw-bold">ğŸ¢ ${company}</h4>`;

                        // ì£¼ë¬¸ë‚´ì—­ í…Œì´ë¸” ì—¬ëŠ” íƒœê·¸
                        html += `<div class="table-responsive mb-5">
                                <table class="table table-bordered text-nowrap">
                                <thead class="table-dark">
                                <tr>
                                <th>No</th>
                                <th>ì œí’ˆëª…</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ì£¼ë¬¸ë‚ ì§œ</th>
                                <th>ê³µì •ì˜ˆì •ì¼</th>
                                <th>ë‹´ë‹¹ì</th>
                                <th>ê³µì •ë³´ê¸°</th>
                             </tr>
                             </thead>
                             <tbody>`;

                        data[company].forEach((order, index) => {
                            // <td>${processLink}</td> ê°’
                            const processLink = order.orderState !== 'PENDING'
                                ? `<a href="/process/${order.productName === 'ë¨í”„ ì»¤ë²„' ? 'b' : 'a'}/${order.orderId}" class="btn btn-sm btn-outline-primary">ë³´ê¸°</a>`
                                : `<span class="text-muted">ì§„í–‰ ì˜ˆì •</span>`;

                            // ì£¼ë¬¸ë‚´ì—­ í…Œì´ë¸” ë³¸ë¬¸ ì˜ì—­ íƒœê·¸
                            html += `<tr>
                                    <td>${index + 1}</td>
                                    <td>${order.productName}</td>
                                    <td>${order.orderQuantity}</td>
                                    <td>${order.orderDate.split('T')[0]}</td>
                                    <td>${order.processDate}</td>
                                    <td>${order.managerName}</td>
                                    <td>${processLink}</td>
                                 </tr>`;
                        });

                        // ì£¼ë¬¸ë‚´ì—­ í…Œì´ë¸” ë‹«ëŠ” íƒœê·¸
                        html += `</tbody></table></div>`;
                    }
                }
                document.getElementById("groupedResult").innerHTML = html;
            })
            .catch(error => {
                console.error('Error fetching grouped orders:', error);
                document.getElementById("groupedResult").innerHTML = `<h5 class="text-danger py-3">âŒ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</h5>`;
            });
    }


    const dateInput = document.getElementById("processDateInput");
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
    loadGroupedOrders(today);

    dateInput.addEventListener("change", function () {
        if (!this.value) return;
        document.getElementById("groupedResult").innerHTML = '<p class="text-muted">ğŸ”„ ë°ì´í„° ë¡œë”© ì¤‘...</p>';
        loadGroupedOrders(this.value);
    });

</script>
<!-- ì¶”ê°€ script ë -->
</html>
